<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAAP11 Transcriptie & Feedback Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 12px;
            margin: 0 5px;
            border-radius: 5px;
            background: #e9ecef;
            color: #6c757d;
            font-weight: bold;
            font-size: 14px;
        }
        .step.active {
            background: #007cba;
            color: white;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 150px;
            font-family: Georgia, serif;
            line-height: 1.6;
            resize: vertical;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover:not(:disabled) {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success-btn {
            background: #28a745;
        }
        .success-btn:hover:not(:disabled) {
            background: #218838;
        }
        .secondary-btn {
            background: #6c757d;
        }
        .secondary-btn:hover:not(:disabled) {
            background: #545b62;
        }
        .status {
            padding: 12px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
            font-weight: 500;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        audio {
            width: 100%;
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background: #007cba;
            width: 0%;
            transition: width 0.5s ease;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        .analysis-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .analysis-type {
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .analysis-type:hover {
            border-color: #007cba;
        }
        .analysis-type.selected {
            border-color: #007cba;
            background: #f8f9fa;
        }
        .analysis-type h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }
        .analysis-type p {
            margin: 0;
            color: #666;
            font-size: 13px;
        }
        .custom-instruction {
            min-height: 120px;
            display: none;
        }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 14px;
            color: #1565c0;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-group button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>KAAP11 MVP Transcriptie & Feedback Tool</h1>
        
        <!-- Progress Steps -->
        <div class="steps">
            <div class="step active">1. Audio Upload</div>
            <div class="step">2. Transcriptie</div>
            <div class="step">3. Feedback</div>
        </div>

        <!-- Setup Section -->
        <div class="section">
            <h2>Setup</h2>
            <div class="input-group">
                <label>OpenAI API Key (voor transcriptie √©n feedback):</label>
                <input type="password" id="openaiKey" placeholder="sk-proj-... of sk-...">
                <div class="info-box" style="margin-top: 5px;">
                    Deze key wordt gebruikt voor zowel Whisper transcriptie als ChatGPT feedback analyse
                </div>
            </div>
            
            <div class="input-group">
                <label>Audio Bestand:</label>
                <input type="file" id="audioFile" accept="audio/*">
                <audio id="audioPlayer" controls style="display:none;"></audio>
            </div>
            
            <button id="transcribeBtn" disabled>Start Transcriptie</button>
            
            <div class="progress-bar" id="progressBar1">
                <div class="progress-fill" id="progressFill1"></div>
            </div>
            
            <div id="status1" class="status"></div>
        </div>

        <!-- Transcription Result -->
        <div class="section" id="transcriptionSection" style="display:none;">
            <h2>Transcriptie Resultaat</h2>
            <div class="info-box">
                Transcriptie voltooid! Je kunt de tekst hieronder nog bewerken voordat je feedback laat genereren.
            </div>
            <div class="input-group">
                <label>Transcriptie (bewerkbaar):</label>
                <textarea id="transcriptionResult" placeholder="Hier verschijnt de transcriptie..."></textarea>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="section" id="analysisSection" style="display:none;">
            <h2>Feedback Generatie</h2>
            
            <div class="input-group">
                <label>Kies Feedback Type:</label>
                <div class="analysis-options">
                    <div class="analysis-type selected" id="recruitmentAnalysis">
                        <h3>üéØ Recruitment Feedback</h3>
                        <p>KAAP11 methodiek voor recruiter gesprekken (via ChatGPT)</p>
                    </div>
                    <div class="analysis-type" id="customAnalysis">
                        <h3>‚öôÔ∏è Custom Feedback</h3>
                        <p>Eigen instructies (via ChatGPT)</p>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <textarea id="customInstruction" class="custom-instruction" placeholder="Beschrijf hier je eigen feedback instructies..."></textarea>
            </div>
            
            <button id="generateFeedbackBtn" class="success-btn" disabled>Genereer Feedback</button>
            
            <div class="progress-bar" id="progressBar2">
                <div class="progress-fill" id="progressFill2"></div>
            </div>
            
            <div id="status2" class="status"></div>
        </div>

        <!-- Feedback Result -->
        <div class="section" id="feedbackSection" style="display:none;">
            <h2>Feedback Resultaat</h2>
            <div class="input-group">
                <label>Gegenereerde Feedback:</label>
                <textarea id="feedbackResult" readonly></textarea>
            </div>
            
            <div class="btn-group">
                <button id="newFeedbackBtn" class="secondary-btn">Nieuwe Feedback</button>
                <button id="restartBtn" class="secondary-btn">Herstart Tool</button>
                <button id="exportBtn" class="success-btn">Exporteer Beide</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let audioData = null;
        let currentStep = 1;
        let analysisType = 'recruitment';
        
        // Updated recruitment instruction with score-based approach
        const recruitmentInstruction = `# Feedback Agent voor Recruiter Intakegesprekken

## Rol en Doel
Je bent een feedback agent gespecialiseerd in het analyseren van kandidaat intakegesprekken van recruiters. Je taak is om constructieve feedback te geven gebaseerd op de Kaap11 training methodieken.

## STAP 1: KANDIDAAT ZOEK-ACTIVITEIT SCORE (VERPLICHT)
Begin ALTIJD met het bepalen van een zoek-activiteit score op schaal 1-10:

**Score 8-10: ACTIEF ZOEKEND**
- Expliciet zoekgedrag ("Ik ben op zoek naar...", "solliciteer momenteel")
- Urgentie ("zo snel mogelijk", "binnen X weken beschikbaar")
- Concrete verwachtingen (specifieke salariseisen, functiewensen)
- Actieve engagement (veel vragen over vacature/proces)

**Score 2-7: LATENTE KANDIDAAT**
- Passieve interesse ("houd ogen open", "als er iets voorbij komt")
- Voorwaardelijk ("alleen voor juiste aanbod")
- Exploratie ("benieuwd naar", "hangt af van omstandigheden")
- Geen urgentie ("heb geen haast", "zit goed waar ik nu zit")

**Score 1: NIET ZOEKEND**
- Expliciet afwijzend ("ben niet op zoek", "heel tevreden")
- Geen interesse (korte antwoorden, weinig engagement)
- Sterke binding ("geweldige werkgever", recente promotie)

## FEEDBACK STRUCTUUR

### üìä KANDIDAAT ANALYSE
**Zoek-Activiteit Score: X/10**
**Kandidaat Type: [ACTIEF ZOEKEND/LATENT/NIET ZOEKEND]**
**Bewijs:** [Citaten die score ondersteunen]

### üéØ METHODIEK EVALUATIE
Gebruik de juiste methodiek op basis van score:
- **Score 8-10**: RedCarpet Intake methodiek
- **Score 2-7**: W.E.R.K. model + LRD techniek
- **Score 1**: Acquisitie benadering

### üìã CONCRETE FEEDBACK
Voor elk aspect geef:
- Wat ging goed (met voorbeelden)
- Wat kan beter (met concrete tips)
- Praktische verbeteracties

### ‚≠ê SAMENVATTING
- Top 3 sterke punten
- Top 3 verbeterpunten
- Concrete actiepunten voor volgende gesprekken

Begin met: "Op basis van de transcriptie bepaal ik eerst de kandidaat zoek-activiteit score..."`;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedKeys();
            setupEventListeners();
        });
        
        function loadSavedKeys() {
            const openaiKey = localStorage.getItem('openai_api_key');
            
            if (openaiKey) document.getElementById('openaiKey').value = openaiKey;
            
            validateInputs();
        }
        
        function setupEventListeners() {
            // Input validation
            document.getElementById('openaiKey').addEventListener('input', validateInputs);
            document.getElementById('audioFile').addEventListener('change', handleFileUpload);
            
            // Main actions
            document.getElementById('transcribeBtn').addEventListener('click', startTranscription);
            document.getElementById('generateFeedbackBtn').addEventListener('click', generateFeedback);
            
            // Analysis type selection
            document.getElementById('recruitmentAnalysis').addEventListener('click', () => selectAnalysisType('recruitment'));
            document.getElementById('customAnalysis').addEventListener('click', () => selectAnalysisType('custom'));
            
            // Control buttons
            document.getElementById('newFeedbackBtn').addEventListener('click', newFeedback);
            document.getElementById('restartBtn').addEventListener('click', restartTool);
            document.getElementById('exportBtn').addEventListener('click', exportReport);
            
            // Text input validation
            document.getElementById('customInstruction').addEventListener('input', validateFeedbackGeneration);
            document.getElementById('transcriptionResult').addEventListener('input', validateFeedbackGeneration);
        }
        
        function validateInputs() {
            const openaiKey = document.getElementById('openaiKey').value;
            const hasAudio = audioData !== null;
            
            document.getElementById('transcribeBtn').disabled = !openaiKey || !hasAudio;
        }
        
        function validateFeedbackGeneration() {
            const transcription = document.getElementById('transcriptionResult').value.trim();
            const hasInstruction = analysisType === 'recruitment' || document.getElementById('customInstruction').value.trim();
            
            document.getElementById('generateFeedbackBtn').disabled = !transcription || !hasInstruction;
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                audioData = null;
                validateInputs();
                return;
            }
            
            // Check file size (25MB limit)
            if (file.size > 25 * 1024 * 1024) {
                showStatus('Bestand te groot. Maximum 25MB toegestaan.', 'error', 1);
                return;
            }
            
            // Check file type
            const extension = file.name.toLowerCase().split('.').pop();
            const supportedFormats = ['mp3', 'wav', 'm4a', 'ogg', 'webm', 'flac'];
            
            if (!supportedFormats.includes(extension)) {
                showStatus('Niet ondersteund formaat. Gebruik: MP3, WAV, M4A, OGG, WEBM of FLAC.', 'error', 1);
                return;
            }
            
            audioData = file;
            
            // Show audio player
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = URL.createObjectURL(file);
            audioPlayer.style.display = 'block';
            
            const sizeInMB = (file.size / 1024 / 1024).toFixed(1);
            showStatus(`Audio geladen: ${file.name} (${sizeInMB}MB)`, 'success', 1);
            
            validateInputs();
        }
        
        async function startTranscription() {
            const openaiKey = document.getElementById('openaiKey').value;
            
            if (!audioData || !openaiKey) return;
            
            // Update UI
            setButtonState('transcribeBtn', true);
            updateSteps(2);
            showProgress(1, 25);
            showStatus('Audio wordt verstuurd naar OpenAI Whisper...', 'success', 1);
            
            try {
                // Prepare form data
                const formData = new FormData();
                formData.append('file', audioData);
                formData.append('model', 'whisper-1');
                formData.append('language', 'nl');
                
                showProgress(1, 50);
                
                // Make API call
                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openaiKey}`
                    },
                    body: formData
                });
                
                showProgress(1, 75);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`OpenAI API error (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                
                if (!result.text) {
                    throw new Error('Geen transcriptie ontvangen van OpenAI');
                }
                
                // Show results
                document.getElementById('transcriptionResult').value = result.text;
                document.getElementById('transcriptionSection').style.display = 'block';
                document.getElementById('analysisSection').style.display = 'block';
                
                showProgress(1, 100);
                showStatus('Transcriptie voltooid! Scroll naar beneden voor feedback generatie.', 'success', 1);
                
                // Save API key
                localStorage.setItem('openai_api_key', openaiKey);
                
                // Auto-resize textarea
                autoResizeTextarea(document.getElementById('transcriptionResult'));
                validateFeedbackGeneration();
                
                setTimeout(() => {
                    hideProgress(1);
                    updateSteps(3);
                }, 2000);
                
            } catch (error) {
                console.error('Transcription error:', error);
                showStatus(`Fout: ${error.message}`, 'error', 1);
                hideProgress(1);
                updateSteps(1);
            } finally {
                setButtonState('transcribeBtn', false);
            }
        }
        
        function selectAnalysisType(type) {
            analysisType = type;
            
            // Update UI
            document.getElementById('recruitmentAnalysis').classList.toggle('selected', type === 'recruitment');
            document.getElementById('customAnalysis').classList.toggle('selected', type === 'custom');
            
            // Show/hide custom instruction field
            const customField = document.getElementById('customInstruction');
            customField.style.display = type === 'custom' ? 'block' : 'none';
            
            // Load saved custom instruction if needed
            if (type === 'custom') {
                const savedInstruction = localStorage.getItem('custom_instruction');
                if (savedInstruction && !customField.value) {
                    customField.value = savedInstruction;
                }
            }
            
            validateFeedbackGeneration();
        }
        
        async function generateFeedback() {
            const openaiKey = document.getElementById('openaiKey').value;
            const transcription = document.getElementById('transcriptionResult').value.trim();
            
            if (!openaiKey || !transcription) return;
            
            // Get instruction
            let instruction = '';
            if (analysisType === 'recruitment') {
                instruction = recruitmentInstruction;
            } else {
                instruction = document.getElementById('customInstruction').value.trim();
                if (!instruction) {
                    showStatus('Voer een custom instructie in.', 'error', 2);
                    return;
                }
                // Save custom instruction
                localStorage.setItem('custom_instruction', instruction);
            }
            
            // Update UI
            setButtonState('generateFeedbackBtn', true);
            showProgress(2, 25);
            showStatus('ChatGPT analyseert het gesprek...', 'success', 2);
            
            try {
                const prompt = `${instruction}

---

Hieronder is de transcriptie van het gesprek dat geanalyseerd moet worden:

${transcription}

Geef je gedetailleerde analyse en feedback volgens de bovenstaande instructies.`;
                
                showProgress(2, 50);
                
                // Make ChatGPT API call
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openaiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            { 
                                role: 'user', 
                                content: prompt 
                            }
                        ],
                        max_tokens: 4000,
                        temperature: 0.3
                    })
                });
                
                showProgress(2, 75);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ChatGPT API Error:', errorText);
                    throw new Error(`ChatGPT API error (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                
                if (!result.choices || !result.choices[0] || !result.choices[0].message || !result.choices[0].message.content) {
                    throw new Error('Geen feedback ontvangen van ChatGPT');
                }
                
                const feedback = result.choices[0].message.content;
                
                // Show results
                document.getElementById('feedbackResult').value = feedback;
                document.getElementById('feedbackSection').style.display = 'block';
                
                showProgress(2, 100);
                showStatus('Feedback gegenereerd! Scroll naar beneden voor het resultaat.', 'success', 2);
                
                // Auto-resize textarea
                autoResizeTextarea(document.getElementById('feedbackResult'));
                
                setTimeout(() => {
                    hideProgress(2);
                    // Scroll to results
                    document.getElementById('feedbackSection').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 2000);
                
            } catch (error) {
                console.error('Feedback generation error:', error);
                showStatus(`Fout: ${error.message}`, 'error', 2);
                hideProgress(2);
            } finally {
                setButtonState('generateFeedbackBtn', false);
            }
        }
        
        function newFeedback() {
            // Reset feedback section
            document.getElementById('feedbackResult').value = '';
            document.getElementById('feedbackSection').style.display = 'none';
            
            // Reset custom instruction if needed
            if (analysisType === 'custom') {
                document.getElementById('customInstruction').value = '';
            }
            
            // Re-validate
            validateFeedbackGeneration();
            
            // Scroll to analysis section
            document.getElementById('analysisSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        function restartTool() {
            // Reset all data
            audioData = null;
            document.getElementById('audioFile').value = '';
            document.getElementById('audioPlayer').style.display = 'none';
            document.getElementById('transcriptionResult').value = '';
            document.getElementById('feedbackResult').value = '';
            document.getElementById('customInstruction').value = '';
            
            // Hide sections
            document.getElementById('transcriptionSection').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('feedbackSection').style.display = 'none';
            
            // Reset progress and status
            hideProgress(1);
            hideProgress(2);
            document.getElementById('status1').style.display = 'none';
            document.getElementById('status2').style.display = 'none';
            
            // Reset steps
            updateSteps(1);
            
            // Reset analysis type
            selectAnalysisType('recruitment');
            
            // Re-validate
            validateInputs();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function exportReport() {
            const transcription = document.getElementById('transcriptionResult').value;
            const report = document.getElementById('feedbackResult').value;
            const timestamp = new Date().toISOString().slice(0, 10);
            
            if (!transcription || !report) {
                showStatus('Geen data om te exporteren', 'error', 2);
                return;
            }
            
            // Export 1: Transcriptie
            const transcriptBlob = new Blob([transcription], { type: 'text/plain;charset=utf-8' });
            const transcriptUrl = URL.createObjectURL(transcriptBlob);
            
            const transcriptLink = document.createElement('a');
            transcriptLink.href = transcriptUrl;
            transcriptLink.download = `KAAP11_Transcriptie_${timestamp}.txt`;
            document.body.appendChild(transcriptLink);
            transcriptLink.click();
            document.body.removeChild(transcriptLink);
            URL.revokeObjectURL(transcriptUrl);
            
            // Export 2: Feedback Analyse (small delay to avoid browser blocking)
            setTimeout(() => {
                const reportBlob = new Blob([report], { type: 'text/plain;charset=utf-8' });
                const reportUrl = URL.createObjectURL(reportBlob);
                
                const reportLink = document.createElement('a');
                reportLink.href = reportUrl;
                reportLink.download = `KAAP11_Feedback_Analyse_${timestamp}.txt`;
                document.body.appendChild(reportLink);
                reportLink.click();
                document.body.removeChild(reportLink);
                URL.revokeObjectURL(reportUrl);
                
                showStatus('Beide bestanden ge√´xporteerd: transcriptie en analyse!', 'success', 2);
            }, 500);
        }
        
        // Utility functions
        function showStatus(message, type, step) {
            const status = document.getElementById(`status${step}`);
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    if (status.textContent === message) {
                        status.style.display = 'none';
                    }
                }, 5000);
            }
        }
        
        function showProgress(step, percentage) {
            const progressBar = document.getElementById(`progressBar${step}`);
            const progressFill = document.getElementById(`progressFill${step}`);
            
            progressBar.style.display = 'block';
            progressFill.style.width = `${percentage}%`;
        }
        
        function hideProgress(step) {
            const progressBar = document.getElementById(`progressBar${step}`);
            progressBar.style.display = 'none';
            document.getElementById(`progressFill${step}`).style.width = '0%';
        }
        
        function setButtonState(buttonId, disabled) {
            document.getElementById(buttonId).disabled = disabled;
        }
        
        function updateSteps(activeStep) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber < activeStep) {
                    step.classList.add('completed');
                } else if (stepNumber === activeStep) {
                    step.classList.add('active');
                }
            });
        }
        
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(textarea.scrollHeight, 150) + 'px';
        }
        
        // Auto-resize textareas on input
        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'TEXTAREA') {
                autoResizeTextarea(e.target);
            }
        });
    </script>
</body>
</html>
